<html ng-app="NewApp">
<head>
	<link href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css" rel="stylesheet">
	<script src="https://code.jquery.com/jquery-1.11.2.min.js"></script>
	<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.2/js/bootstrap.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.3.14/angular.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.3.14/angular-route.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.3.14/angular-sanitize.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.3.14/angular-resource.min.js"></script>
</head>

   <body  ng-controller="IframeCtrl" >
    <div id="helloid" my-customer> 
      <div>hello</div>
    </div>
    

    <script type="text/javascript">
var myAppModule = angular.module('NewApp', ['ngRoute','ngSanitize']); 
myAppModule.controller('IframeCtrl', [ '$scope', '$sce', '$compile',function($scope,$sce,$compile) {
    
    $scope.value = "<h1>hello there</h1>";
    $scope.iframe_agent = {
      name: 'Naomicker',
      address: '1600 Amphitheatre',
      markup : '<div><h1>hello world !</h1></div>'
    };


  $scope.renderHtml = function(html_code)
  {
      return $sce.trustAsHtml(html_code);
  };

        window.updatedata = function(data) {
          $scope.$apply(function(){

            $scope.value = data;
            $scope.rendered_value = $scope.value;
    //        console.log("applied changes");
            $scope.iframe_agent.markup = '<div>' + $scope.value.toString() + '</div>';
            //$scope.iframe_agent.markup = $scope.value.toString();
          });
        };
    $scope.rendered_value = $scope.value;


}]);



myAppModule.directive('myCustomer', ['$interval','$compile',function($interval,$compile) {
  var directive_obj = {};

  var post_func = function(scope ,elem) {
    console.log("hi there from post link to : " + scope.iframe_agent.name + parent);
    
    // window.updatedata = function(data) {
    //     scope.$apply(function(){
    //       scope.iframe_agent.markup = data;
    //     });
    //   console.log("called here" + data);
    // //  elem.children().replaceWith($compile(data)(scope));
    // //  applychanges(data);
    //   }

    console.log(elem.parent());
    scope.$watch(' iframe_agent.markup', function() {
           //  console.log("from direct " + scope.iframe_agent.markup);
              //elem.append('<div></div>')replaceWith(angular.element(scope.iframe_agent.markup));
             //console.log(elem.children().replaceWith($compile(scope.iframe_agent.markup)(scope));
              //elem.children().replaceWith(angular.element(scope.iframe_agent.markup));
            //var compiled = angular.element(scope.iframe_agent.markup);
              //elem.children().replaceWith();
              applychanges(scope.iframe_agent.markup);
      });


      var applychanges = function(data) {
      elem.children().replaceWith($compile(data)(scope));
    }

  //  scope.$watch(scope.iframe_agent.markup);
  //  var $parser_markup = angular.element(scope.iframe_agent.markup);
  //  parent.appendChild($parser_markup);

  //  angular.element("<div></div>");
//    angular.element(scope.iframe_agent.markup);
  }

  var pre_func = function(scope) {
    console.log("hi there from pre link to : " + scope.iframe_agent.name);
  }

  var control_func = function($scope,$element,$attrs) {
    
    console.log("hi there from control to : " + $scope.iframe_agent.name );
    $scope.parsed_markup = function() {
      return angular.element($scope.iframe_agent.markup); 
    }

    //angular.element($scope.iframe_agent.markup);
     // var counter = 0;
     // var timeoutId = $interval(function() {
   //       //$element.parent().append($scope.parsed_markup());

   //       // $element.replaceWith($scope.parsed_markup());
   //       // counter++;
   //       if(counter > 5) {
   //         $interval.cancel(timeoutId);
            
   //         console.log(counter);
   //       }
    //    counter++;
     // //   $scope.iframe_agent.markup = '<div>' + counter.toString() +  '</div>';
    
   //   }, 1000);

    // $scope.$watch(' iframe_agent.markup', function() {
  //              console.log("from direct " + $scope.iframe_agent.markup);
  //              $element.replaceWith($compile($scope.iframe_agent.markup)($scope)););
  //      });

  } 

  var compile_func = function() {
    console.log("hi there from compile" );  

    return {
      pre : pre_func,
      post: post_func
    }
  };
  //var validElement = angular.element("<div>hello</div>");
  console.log("ho from directive");
  directive_obj =  {  restrict: "EA",
          //  replace: true ,
            templateNamespace: 'html',
           //   template: '<div>Name: {{iframe_agent.name}} Address: {{iframe_agent.address}}</div>',
              controller: control_func,
              compile: compile_func
           };


    return directive_obj;
}]);




    </script>
  </body>
</html>